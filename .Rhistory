ein = EIN
) %>%
mutate(ein = str_remove_all(as.character(ein), "-"))
print(paste("Loaded", nrow(peers), "schools"))
find_xml_file <- function(ein, xml_dir = "/Users/jakecox/rstudio/990-scraper/990_XML") {
xml_files <- list.files(xml_dir, pattern = "\\.xml$", full.names = TRUE, ignore.case = TRUE)
matching <- xml_files[grepl(ein, xml_files, ignore.case = TRUE)]
if (length(matching) > 0) {
return(matching[1])
}
return(NA_character_)
}
extract_basketball_coach <- function(xml_path) {
if (is.na(xml_path) || !file.exists(xml_path)) {
warning("  XML file not found")
return(NULL)
}
doc <- tryCatch({
read_xml(xml_path)
}, error = function(e) {
warning("  Could not read XML: ", e$message)
return(NULL)
})
if (is.null(doc)) return(NULL)
nodes <- xml_find_all(doc, "//*[local-name()='Form990PartVIISectionAGrp']")
if (length(nodes) == 0) {
message("  No officer nodes found")
return(NULL)
}
officers <- map_df(nodes, function(n) {
tibble(
name = xml_text(xml_find_first(n, ".//*[local-name()='PersonNm']")),
title = xml_text(xml_find_first(n, ".//*[local-name()='TitleTxt']")),
comp_org = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='ReportableCompFromOrgAmt']")))),
comp_related = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='ReportableCompFromRltdOrgAmt']")))),
comp_other = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='OtherCompensationAmt']"))))
)
}) %>%
filter(!is.na(name), name != "")
if (nrow(officers) == 0) {
message("  No officers found")
return(NULL)
}
bball_coach <- officers %>%
filter(str_detect(tolower(title), "basketball|men's basketball|mens basketball|head coach.*basketball|coach.*men"))
if (nrow(bball_coach) == 0) {
message("  No basketball coach found")
return(NULL)
}
# If multiple matches, take highest paid
coach <- bball_coach %>%
slice_max(comp_org, n = 1, with_ties = FALSE) %>%
slice(1)
message("  Found coach: ", coach$name, " - ", coach$title)
return(coach)
}
message("\nStarting to process ", nrow(peers), " organizations...")
results <- peers %>%
mutate(
xml_file = map_chr(ein, function(e) {
message("\nProcessing: ", school, " (EIN: ", e, ")")
xml_path <- find_xml_file(e)
if (is.na(xml_path)) {
message("  XML file not found")
} else {
message("  Found: ", basename(xml_path))
}
return(xml_path)
})
) %>%
filter(!is.na(xml_file)) %>%
mutate(
coach_data = map(xml_file, extract_basketball_coach)
) %>%
filter(!map_lgl(coach_data, is.null)) %>%
unnest(coach_data, keep_empty = FALSE)
if (nrow(results) > 0) {
out_path <- "/Users/jakecox/rstudio/990-scraper/basketball_coach_compensation.csv"
write_csv(results, out_path)
message("\n✓ Success! Saved ", nrow(results), " basketball coaches of ", nrow(peers), " schools to:")
message("  ", out_path)
# Show preview
print(results %>% select(school, ein, name, title, comp_org))
} else {
warning("\n✗ No basketball coaches found in any 990 forms")
}
message("\n=== SUMMARY ===")
message("Schools with basketball coaches found: ", nrow(results))
library(dplyr)
library(readr)
library(purrr)
library(stringr)
library(xml2)
library(tidyr)
peers <- read_csv(
"/Users/jakecox/rstudio/990-scraper/peers_eins.csv",
show_col_types = FALSE
) %>%
rename(
school = SCHOOL,
ein = EIN
) %>%
mutate(ein = str_remove_all(as.character(ein), "-"))
print(paste("Loaded", nrow(peers), "schools"))
find_xml_file <- function(ein, xml_dir = "/Users/jakecox/rstudio/990-scraper/990_XML") {
xml_files <- list.files(xml_dir, pattern = "\\.xml$", full.names = TRUE, ignore.case = TRUE)
matching <- xml_files[grepl(ein, xml_files, ignore.case = TRUE)]
if (length(matching) > 0) {
return(matching[1])
}
return(NA_character_)
}
extract_womens_basketball_coach <- function(xml_path) {
if (is.na(xml_path) || !file.exists(xml_path)) {
warning("  XML file not found")
return(NULL)
}
doc <- tryCatch({
read_xml(xml_path)
}, error = function(e) {
warning("  Could not read XML: ", e$message)
return(NULL)
})
if (is.null(doc)) return(NULL)
nodes <- xml_find_all(doc, "//*[local-name()='Form990PartVIISectionAGrp']")
if (length(nodes) == 0) {
message("  No officer nodes found")
return(NULL)
}
officers <- map_df(nodes, function(n) {
tibble(
name = xml_text(xml_find_first(n, ".//*[local-name()='PersonNm']")),
title = xml_text(xml_find_first(n, ".//*[local-name()='TitleTxt']")),
comp_org = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='ReportableCompFromOrgAmt']")))),
comp_related = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='ReportableCompFromRltdOrgAmt']")))),
comp_other = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='OtherCompensationAmt']"))))
)
}) %>%
filter(!is.na(name), name != "")
if (nrow(officers) == 0) {
message("  No officers found")
return(NULL)
}
wbball_coach <- officers %>%
filter(str_detect(tolower(title), "women's basketball|womens basketball|women basketball|head coach.*women|coach.*women"))
if (nrow(wbball_coach) == 0) {
message("  No women's basketball coach found")
return(NULL)
}
coach <- wbball_coach %>%
slice_max(comp_org, n = 1, with_ties = FALSE) %>%
slice(1)
message("  Found coach: ", coach$name, " - ", coach$title)
return(coach)
}
message("\nStarting to process ", nrow(peers), " organizations...")
results <- peers %>%
mutate(
xml_file = map_chr(ein, function(e) {
message("\nProcessing: ", school, " (EIN: ", e, ")")
xml_path <- find_xml_file(e)
if (is.na(xml_path)) {
message("  XML file not found")
} else {
message("  Found: ", basename(xml_path))
}
return(xml_path)
})
) %>%
filter(!is.na(xml_file)) %>%
mutate(
coach_data = map(xml_file, extract_womens_basketball_coach)
) %>%
filter(!map_lgl(coach_data, is.null)) %>%
unnest(coach_data, keep_empty = FALSE)
if (nrow(results) > 0) {
out_path <- "/Users/jakecox/rstudio/990-scraper/womens_basketball_coach_compensation.csv"
write_csv(results, out_path)
message("\n✓ Success! Saved ", nrow(results), " women's basketball coaches of ", nrow(peers), " schools to:")
message("  ", out_path)
# Show preview
print(results %>% select(school, ein, name, title, comp_org))
} else {
warning("\n✗ No women's basketball coaches found in any 990 forms")
}
library(dplyr)
library(readr)
library(purrr)
library(stringr)
library(xml2)
library(tidyr)
peers <- read_csv(
"/Users/jakecox/rstudio/990-scraper/peers_eins.csv",
show_col_types = FALSE
) %>%
rename(
school = SCHOOL,
ein = EIN
) %>%
mutate(ein = str_remove_all(as.character(ein), "-"))
print(paste("Loaded", nrow(peers), "schools"))
find_xml_file <- function(ein, xml_dir = "/Users/jakecox/rstudio/990-scraper/990_XML") {
xml_files <- list.files(xml_dir, pattern = "\\.xml$", full.names = TRUE, ignore.case = TRUE)
matching <- xml_files[grepl(ein, xml_files, ignore.case = TRUE)]
if (length(matching) > 0) {
return(matching[1])
}
return(NA_character_)
}
extract_all_officers <- function(xml_path) {
if (is.na(xml_path) || !file.exists(xml_path)) {
warning("  XML file not found")
return(NULL)
}
doc <- tryCatch({
read_xml(xml_path)
}, error = function(e) {
warning("  Could not read XML: ", e$message)
return(NULL)
})
if (is.null(doc)) return(NULL)
if (length(nodes) == 0) {
message("  No officer nodes found")
return(NULL)
}
officers <- map_df(nodes, function(n) {
tibble(
name = xml_text(xml_find_first(n, ".//*[local-name()='PersonNm']")),
title = xml_text(xml_find_first(n, ".//*[local-name()='TitleTxt']")),
comp_org = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='ReportableCompFromOrgAmt']")))),
comp_related = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='ReportableCompFromRltdOrgAmt']")))),
comp_other = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='OtherCompensationAmt']"))))
)
}) %>%
filter(!is.na(name), name != "")
return(officers)
}
message("\nStarting to process ", nrow(peers), " organizations...")
all_officers <- peers %>%
mutate(
xml_file = map_chr(ein, function(e) {
message("\nProcessing: ", school, " (EIN: ", e, ")")
xml_path <- find_xml_file(e)
if (is.na(xml_path)) {
message("  XML file not found")
} else {
message("  Found: ", basename(xml_path))
}
return(xml_path)
})
) %>%
filter(!is.na(xml_file)) %>%
mutate(
officers_data = map(xml_file, extract_all_officers)
) %>%
filter(!map_lgl(officers_data, is.null)) %>%
unnest(officers_data, keep_empty = FALSE)
extract_all_officers <- function(xml_path) {
if (is.na(xml_path) || !file.exists(xml_path)) {
warning("  XML file not found")
return(NULL)
}
doc <- tryCatch({
read_xml(xml_path)
}, error = function(e) {
warning("  Could not read XML: ", e$message)
return(NULL)
})
if (is.null(doc)) return(NULL)
# Try different XPath patterns
nodes <- xml_find_all(doc, "//*[local-name()='Form990PartVIISectionAGrp']")
if (length(nodes) == 0) {
message("  No officer nodes found")
return(NULL)
}
officers <- map_df(nodes, function(n) {
tibble(
name = xml_text(xml_find_first(n, ".//*[local-name()='PersonNm']")),
title = xml_text(xml_find_first(n, ".//*[local-name()='TitleTxt']")),
comp_org = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='ReportableCompFromOrgAmt']")))),
comp_related = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='ReportableCompFromRltdOrgAmt']")))),
comp_other = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='OtherCompensationAmt']"))))
)
}) %>%
filter(!is.na(name), name != "")
return(officers)
}
message("\nStarting to process ", nrow(peers), " organizations...")
all_officers <- peers %>%
mutate(
xml_file = map_chr(ein, function(e) {
message("\nProcessing: ", school, " (EIN: ", e, ")")
xml_path <- find_xml_file(e)
if (is.na(xml_path)) {
message("  XML file not found")
} else {
message("  Found: ", basename(xml_path))
}
return(xml_path)
})
) %>%
filter(!is.na(xml_file)) %>%
mutate(
officers_data = map(xml_file, extract_all_officers)
) %>%
filter(!map_lgl(officers_data, is.null)) %>%
unnest(officers_data, keep_empty = FALSE)
message("\n\nSearching for basketball coaches in titles...")
basketball_titles <- all_officers %>%
filter(str_detect(tolower(title), "basketball|coach")) %>%
select(school, name, title, comp_org) %>%
arrange(school, title)
write_csv(basketball_titles, "/Users/jakecox/rstudio/990-scraper/all_basketball_titles.csv")
message("\nSaved all basketball-related titles to: all_basketball_titles.csv")
message("Review this file to see what titles exist")
womens_coaches <- basketball_titles %>%
filter(str_detect(tolower(title), "women|w\\.b\\.|w/|wbb|female"))
womens_coaches_alt <- basketball_titles %>%
filter(
str_detect(tolower(title), "basketball"),
!str_detect(tolower(title), "men|m\\.b\\.|m/|mbb|male|assistant")
)
results <- bind_rows(womens_coaches, womens_coaches_alt) %>%
distinct(school, name, .keep_all = TRUE) %>%
group_by(school) %>%
slice_max(comp_org, n = 1, with_ties = FALSE) %>%
ungroup()
if (nrow(results) > 0) {
out_path <- "/Users/jakecox/rstudio/990-scraper/womens_basketball_coach_compensation.csv"
write_csv(results, out_path)
message("\n✓ Success! Saved ", nrow(results), " women's basketball coaches")
message("  ", out_path)
} else {
warning("\n✗ No women's basketball coaches found")
}
message("\n=== SUMMARY ===")
message("Total schools processed: ", length(unique(all_officers$school)))
message("Schools with ANY basketball titles: ", length(unique(basketball_titles$school)))
message("Schools with women's basketball coaches identified: ", nrow(results))
message("\nSchools missing women's basketball coaches:")
missing_schools <- peers %>%
filter(!school %in% results$school) %>%
pull(school)
print(missing_schools)
print(missing_schools)
peers <- read_csv(
"/Users/jakecox/rstudio/990-scraper/peers_eins.csv",
show_col_types = FALSE
) %>%
rename(
school = SCHOOL,
ein = EIN
) %>%
mutate(ein = str_remove_all(as.character(ein), "-"))
print(paste("Loaded", nrow(peers), "schools"))
find_xml_file <- function(ein, xml_dir = "/Users/jakecox/rstudio/990-scraper/990_XML") {
xml_files <- list.files(xml_dir, pattern = "\\.xml$", full.names = TRUE, ignore.case = TRUE)
matching <- xml_files[grepl(ein, xml_files, ignore.case = TRUE)]
if (length(matching) > 0) {
return(matching[1])
}
return(NA_character_)
}
extract_all_officers <- function(xml_path) {
if (is.na(xml_path) || !file.exists(xml_path)) {
warning("  XML file not found")
return(NULL)
}
doc <- tryCatch({
read_xml(xml_path)
}, error = function(e) {
warning("  Could not read XML: ", e$message)
return(NULL)
})
if (is.null(doc)) return(NULL)
# Try different XPath patterns
nodes <- xml_find_all(doc, "//*[local-name()='Form990PartVIISectionAGrp']")
if (length(nodes) == 0) {
message("  No officer nodes found")
return(NULL)
}
officers <- map_df(nodes, function(n) {
tibble(
name = xml_text(xml_find_first(n, ".//*[local-name()='PersonNm']")),
title = xml_text(xml_find_first(n, ".//*[local-name()='TitleTxt']")),
comp_org = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='ReportableCompFromOrgAmt']")))),
comp_related = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='ReportableCompFromRltdOrgAmt']")))),
comp_other = suppressWarnings(as.numeric(xml_text(xml_find_first(n, ".//*[local-name()='OtherCompensationAmt']"))))
)
}) %>%
filter(!is.na(name), name != "")
return(officers)
}
message("\nStarting to process ", nrow(peers), " organizations...")
all_officers <- peers %>%
mutate(
xml_file = map_chr(ein, function(e) {
message("\nProcessing: ", school, " (EIN: ", e, ")")
xml_path <- find_xml_file(e)
if (is.na(xml_path)) {
message("  XML file not found")
} else {
message("  Found: ", basename(xml_path))
}
return(xml_path)
})
) %>%
filter(!is.na(xml_file)) %>%
mutate(
officers_data = map(xml_file, extract_all_officers)
) %>%
filter(!map_lgl(officers_data, is.null)) %>%
unnest(officers_data, keep_empty = FALSE)
all_officers <- peers %>%
mutate(
xml_file = map_chr(ein, function(e) {
message("\nProcessing: ", school, " (EIN: ", e, ")")
xml_path <- find_xml_file(e)
if (is.na(xml_path)) {
message("  XML file not found")
} else {
message("  Found: ", basename(xml_path))
}
return(xml_path)
})
) %>%
filter(!is.na(xml_file)) %>%
mutate(
officers_data = map(xml_file, extract_all_officers)
) %>%
filter(!map_lgl(officers_data, is.null)) %>%
unnest(officers_data, keep_empty = FALSE)
message("\n\nSearching for basketball coaches in titles...")
# First, let's see ALL basketball-related titles
basketball_titles <- all_officers %>%
filter(str_detect(tolower(title), "basketball|coach")) %>%
select(school, ein, xml_file, name, title, comp_org, comp_related, comp_other) %>%
arrange(school, title)
write_csv(basketball_titles, "/Users/jakecox/rstudio/990-scraper/all_basketball_titles.csv")
message("\nSaved all basketball-related titles to: all_basketball_titles.csv")
message("Review this file to see what titles exist")
womens_coaches <- basketball_titles %>%
filter(str_detect(tolower(title), "women|w\\.b\\.|w/|wbb|female"))
message("Review this file to see what titles exist")
womens_coaches_alt <- basketball_titles %>%
filter(
str_detect(tolower(title), "basketball"),
!str_detect(tolower(title), "men|m\\.b\\.|m/|mbb|male|assistant")
)
results <- bind_rows(womens_coaches, womens_coaches_alt) %>%
distinct(school, name, .keep_all = TRUE) %>%
group_by(school) %>%
slice_max(comp_org, n = 1, with_ties = FALSE) %>%
ungroup()
if (nrow(results) > 0) {
out_path <- "/Users/jakecox/rstudio/990-scraper/womens_basketball_coach_compensation.csv"
write_csv(results, out_path)
message("\n✓ Success! Saved ", nrow(results), " women's basketball coaches")
message("  ", out_path)
# Show preview with all comp columns
print(results %>% select(school, name, title, comp_org, comp_related, comp_other))
} else {
warning("\n✗ No women's basketball coaches found")
}
message("\n=== SUMMARY ===")
message("Total schools processed: ", length(unique(all_officers$school)))
message("Schools with ANY basketball titles: ", length(unique(basketball_titles$school)))
message("Schools with women's basketball coaches identified: ", nrow(results))
message("\nSchools missing women's basketball coaches:")
missing_schools <- peers %>%
filter(!school %in% results$school) %>%
pull(school)
print(missing_schools)
library(dplyr)
library(readr)
ceo <- read_csv("/Users/jakecox/rstudio/990-scraper/peer_exec_compensation.csv")
mens_bball <- read_csv("/Users/jakecox/rstudio/990-scraper/basketball_coach_compensation.csv")
womens_bball <- read_csv("/Users/jakecox/rstudio/990-scraper/womens_basketball_coach_compensation.csv")
ceo_wide <- ceo %>%
select(school, ein,
ceo_name = name,
ceo_title = title,
ceo_comp_org = comp_org,
ceo_comp_related = comp_related,
ceo_comp_other = comp_other)
mens_wide <- mens_bball %>%
select(school, ein,
mens_coach_name = name,
mens_coach_title = title,
mens_coach_comp_org = comp_org,
mens_coach_comp_related = comp_related,
mens_coach_comp_other = comp_other)
womens_wide <- womens_bball %>%
select(school, ein,
womens_coach_name = name,
womens_coach_title = title,
womens_coach_comp_org = comp_org,
womens_coach_comp_related = comp_related,
womens_coach_comp_other = comp_other)
combined_wide <- ceo_wide %>%
full_join(mens_wide, by = c("school", "ein")) %>%
full_join(womens_wide, by = c("school", "ein"))
out_path <- "/Users/jakecox/rstudio/990-scraper/all_compensation_wide.csv"
write_csv(combined_wide, out_path)
message("✓ Saved wide format to: ", out_path)
print(combined_wide)
View(combined_wide)
message("\n=== SUMMARY ===")
message("Total schools: ", nrow(combined_wide))
message("Schools with CEO data: ", sum(!is.na(combined_wide$ceo_name)))
message("Schools with Men's Basketball Coach: ", sum(!is.na(combined_wide$mens_coach_name)))
message("Schools with Women's Basketball Coach: ", sum(!is.na(combined_wide$womens_coach_name)))
